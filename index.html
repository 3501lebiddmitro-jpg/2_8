<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Matrix Chat - Demo</title>

  <!-- Tailwind (CDN for demo; for production install via PostCSS/CLI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- App styles -->
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="login.css">
  <link rel="stylesheet" href="sidebar.css">

  <!-- App scripts (order matters: login/sidebar helpers first, chat core last) -->
  <script src="./login.js" defer></script>
  <script src="./sidebar.js" defer></script>
  <script src="./chat.js" defer></script>
</head>
<body class="index-container bg-gray-100 flex justify-center">

  <!-- Main container (note: removed max-w-5xl per task and padding p-4) -->
  <div x-data="chatApp()" class="flex w-full min-h-screen">

    <!-- Sidebar placeholder (will be loaded from sidebar.html) -->
    <div id="sidebar-placeholder" class="hidden lg:block w-72"></div>

    <!-- User component placeholder (for invites, members) -->
    <div id="user-placeholder" class="hidden lg:block w-72"></div>

    <!-- Chat area -->
    <main class="chat-area flex-1 flex flex-col">
      <!-- Header -->
      <header class="p-4 bg-white border-b">
        <div class="max-w-full mx-auto flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <h1 class="text-2xl font-bold">Matrix Chat</h1>
            <div x-show="accessToken" class="text-sm text-gray-600">You: <span x-text="userId || username"></span></div>
          </div>

          <div class="flex items-center space-x-2">
            <button x-show="!accessToken" @click="showLogin = !showLogin" class="px-3 py-1 rounded bg-indigo-500 text-white">Login</button>
            <button x-show="accessToken" @click="logout()" class="px-3 py-1 rounded border">Logout</button>
          </div>
        </div>
      </header>

      <!-- Login modal / panel -->
      <div x-show="!accessToken" class="flex-0">
        <div id="login-container" class="mt-8">
          <!-- login.html content is simple and controlled by Alpine state -->
          <form @submit.prevent="login()" class="space-y-3">
            <h2 class="text-lg font-semibold">Login</h2>
            <div>
              <label class="block text-sm">Homeserver URL</label>
              <input x-model="homeserver" class="w-full border p-2 rounded" placeholder="https://matrix.org" />
            </div>
            <div>
              <label class="block text-sm">Username</label>
              <input x-model="username" class="w-full border p-2 rounded" placeholder="@user:matrix.org or just local part" />
            </div>
            <div>
              <label class="block text-sm">Password / Access token</label>
              <input x-model="password" type="password" class="w-full border p-2 rounded" placeholder="password or access token" />
            </div>
            <div class="flex space-x-2">
              <button type="submit" class="bg-indigo-500 text-white px-3 py-1 rounded">Login</button>
              <button type="button" @click="loginAsGuest()" class="px-3 py-1 border rounded">Guest (no auth)</button>
            </div>
            <p x-show="error" class="text-red-600 text-sm" x-text="error"></p>
          </form>
        </div>
      </div>

      <!-- Messages area -->
      <section class="flex-1 overflow-hidden flex flex-col bg-white">
        <div class="messages p-4 overflow-auto flex-1" x-ref="messagesBox">
          <template x-if="messages.length === 0">
            <p class="text-gray-500">No messages yet</p>
          </template>
          <template x-for="m in messages" :key="m.event_id">
            <div class="mb-3">
              <div class="text-xs text-gray-500" x-text="m.sender"></div>
              <div class="p-2 rounded bg-gray-100 inline-block" x-html="m.body"></div>
            </div>
          </template>
        </div>

        <!-- Input -->
        <div class="p-4 border-t bg-gray-50">
          <form @submit.prevent="sendMessage()" class="flex items-end gap-2">
            <textarea x-model="newMessage" class="message-input flex-1 border p-2 rounded" placeholder="Type a message..."></textarea>
            <button class="px-4 py-2 bg-indigo-500 text-white rounded" type="submit">Send</button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <script>
    // On load, insert sidebar & user templates via fetch for componentization
    // (These files are provided separately: sidebar.html, user.html)
    (async function loadFragments() {
      try {
        const s = await fetch('sidebar.html').then(r => r.text());
        document.getElementById('sidebar-placeholder').innerHTML = s;
        document.getElementById('sidebar-placeholder').classList.remove('hidden');

        const u = await fetch('user.html').then(r => r.text());
        document.getElementById('user-placeholder').innerHTML = u;
        document.getElementById('user-placeholder').classList.remove('hidden');
      } catch (e) {
        // If fetch fails (file:// restrictions), leave placeholders hidden.
        console.warn('Could not load sidebar/user fragments via fetch (use a local server to avoid file:// restrictions).', e);
      }
    })();
  </script>
</body>
</html>
